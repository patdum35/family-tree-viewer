import { state } from './main.js';
import { displayPersonDetails } from './modalWindow.js';
import { nameCloudState } from './nameCloud.js';
import { saveHeatmapPosition, makeElementDraggable } from './geoHeatMapInteractions.js';
import { refreshHeatmap } from './geoHeatMapDataProcessor.js';

/**
 * Cr√©e et affiche la heatmap avec son interface utilisateur
 * 
 * @param {Array} locationData - Donn√©es de localisation pour la heatmap
 * @param {String} heatmapTitle - Titre √† afficher pour la heatmap
 * @returns {HTMLElement} - L'√©l√©ment wrapper de la heatmap cr√©√©e
 */
export function createImprovedHeatmap(locationData, heatmapTitle) {
    // Fermer toute carte existante d'abord
    const existingMap = document.getElementById('namecloud-heatmap-wrapper');
    if (existingMap) {
        document.body.removeChild(existingMap);
    }

    // Cr√©er un conteneur principal (semi-transparent) qui ne couvre pas tout l'√©cran
    const heatmapWrapper = document.createElement('div');

    heatmapWrapper.id = 'namecloud-heatmap-wrapper';
    heatmapWrapper.style.position = 'fixed';
    heatmapWrapper.style.top = '60px'; // Remont√© de 20px comme demand√©
    heatmapWrapper.style.left = '20px';
    heatmapWrapper.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
    heatmapWrapper.style.zIndex = '9000'; // √âlev√© mais inf√©rieur aux contr√¥les (11000+)
    heatmapWrapper.style.display = 'flex'; // IMPORTANT - NE PAS SUPPRIMER
    heatmapWrapper.style.flexDirection = 'column';
    heatmapWrapper.style.borderRadius = '10px';
    heatmapWrapper.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.3)';
    heatmapWrapper.style.overflow = 'hidden';
    heatmapWrapper.style.resize = 'both'; // Permettre le redimensionnement
    heatmapWrapper.style.minWidth = '50px'; //'400px';
    heatmapWrapper.style.minHeight = '50px'; //'300px';

    function applyHeatmapPosition() {
        // Appliquer les dimensions et positions sauvegard√©es
        if (nameCloudState.heatmapPosition) {
            
            const validPosition = 
                nameCloudState.heatmapPosition.top !== undefined && 
                nameCloudState.heatmapPosition.left !== undefined &&
                nameCloudState.heatmapPosition.width !== undefined && 
                nameCloudState.heatmapPosition.height !== undefined &&
                nameCloudState.heatmapPosition.width >= 200 &&  // Taille minimale raisonnable
                nameCloudState.heatmapPosition.height >= 150;   // Taille minimale raisonnable
                
                    
            // V√©rifier que les valeurs sauvegard√©es sont valides
            if (validPosition) {
                // Pour la position
                heatmapWrapper.style.top = `${nameCloudState.heatmapPosition.top}px`;
                heatmapWrapper.style.left = `${nameCloudState.heatmapPosition.left}px`;
                
                // Pour les dimensions
                heatmapWrapper.style.width = `${nameCloudState.heatmapPosition.width}px`;
                heatmapWrapper.style.height = `${nameCloudState.heatmapPosition.height}px`;
                
                return true;
            } else {
                console.warn("Position sauvegard√©e invalide ou trop petite:", nameCloudState.heatmapPosition);
                // R√©initialiser les valeurs probl√©matiques
                nameCloudState.heatmapPosition = null;
            }
        } else {
            console.log("Aucune position sauvegard√©e √† appliquer");
        }
        
        return false;
    }

    if (!applyHeatmapPosition()) {
        // Revenir aux valeurs par d√©faut d'origine
        heatmapWrapper.style.top = '60px';
        heatmapWrapper.style.left = '20px';
        heatmapWrapper.style.width = 'calc(100% - 40px)';
        heatmapWrapper.style.height = 'calc(100% - 100px)';
    }

    // Ajoutez √©galement un √©couteur d'√©v√©nement pour le redimensionnement de la fen√™tre
    if (window._resizeHeatmapListener) {
        window.removeEventListener('resize', window._resizeHeatmapListener);
    }

    // D√©finir et stocker le nouvel √©couteur
    window._resizeHeatmapListener = function() {
        const wrapper = document.getElementById('namecloud-heatmap-wrapper');
        if (!wrapper) return;
        
        // Obtenir les dimensions actuelles
        const wrapperRect = wrapper.getBoundingClientRect();
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        // V√©rifier si la heatmap d√©passerait les limites de l'√©cran
        let needsResize = false;
        
        // Si la largeur d√©passe l'√©cran moins la marge
        if (wrapperRect.right > windowWidth - 20) {
            needsResize = true;
        }
        
        // Si la hauteur d√©passe l'√©cran moins la marge
        if (wrapperRect.bottom > windowHeight - 20) {
            needsResize = true;
        }
        
        // Seulement redimensionner si n√©cessaire
        if (needsResize) {
            // Calculer les nouvelles dimensions pour respecter les marges
            const newWidth = Math.min(wrapperRect.width, windowWidth - 40);
            const newHeight = Math.min(wrapperRect.height, windowHeight - 100);
            
            // Appliquer les nouvelles dimensions
            wrapper.style.width = `${newWidth}px`;
            wrapper.style.height = `${newHeight}px`;
            
            // Rafra√Æchir la carte
            if (wrapper.map) {
                setTimeout(() => {
                    wrapper.map.invalidateSize();
                    
                    // Mettre √† jour heat si disponible
                    const heat = wrapper.map._layers && Object.values(wrapper.map._layers).find(layer => 
                        layer && layer.setLatLngs && typeof layer._reset === 'function');
                    if (heat) {
                        heat._reset();
                    }
                }, 0);
            }
            
            // Sauvegarder la nouvelle position
            if (typeof saveHeatmapPosition === 'function') {
                saveHeatmapPosition();
            }
        }
    };

    // Ajouter l'√©couteur
    window.addEventListener('resize', window._resizeHeatmapListener);

    // Nous cr√©ons un titleBar invisible pour permettre le drag m√™me si la barre de titre n'est pas visible
    const titleBar = document.createElement('div');
    titleBar.style.padding = '8px 12px';
    titleBar.style.backgroundColor = '#4361ee';
    titleBar.style.color = 'white';
    titleBar.style.fontWeight = 'bold';
    titleBar.style.display = 'none'; // Masqu√© par d√©faut - MODE PETIT √âCRAN
    titleBar.style.justifyContent = 'space-between';
    titleBar.style.alignItems = 'center';
    titleBar.style.cursor = 'move'; // Indiquer que c'est d√©pla√ßable
    titleBar.innerHTML = `
        <div class="title-text">${heatmapTitle || ''}</div>
        <div style="display: flex; gap: 10px;">
            <button id="heatmap-refresh" title="Rafra√Æchir la heatmap" 
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">
                üîÑ
            </button>
            <button id="heatmap-close" title="Fermer la heatmap" 
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">
                ‚úñ
            </button>
        </div>
    `;

    // Conteneur de carte
    const mapContainer = document.createElement('div');
    mapContainer.id = 'ancestors-heatmap';
    mapContainer.style.flexGrow = '1';
    mapContainer.style.width = '100%';
    mapContainer.style.margin = '0';
    mapContainer.style.padding = '0';
    mapContainer.style.position = 'relative'; // Assure un positionnement correct
    mapContainer.style.zIndex = '1'; // Assure que la carte est visible dans son conteneur

    // Assembler les √©l√©ments
    heatmapWrapper.appendChild(titleBar);
    heatmapWrapper.appendChild(mapContainer);

    // Ajouter au body
    document.body.appendChild(heatmapWrapper);

    // Ajouter une poign√©e de d√©placement toujours visible
    const dragHandle = document.createElement('div');
    dragHandle.className = 'heatmap-drag-handle';
    dragHandle.innerHTML = '‚ú•'; //'‚ãÆ‚ãÆ'; // Symbole de d√©placement (quatre points de suspension verticaux)
    dragHandle.style.position = 'absolute';
    dragHandle.style.top = '3px';
    dragHandle.style.left = '3px';
    dragHandle.style.width = '30px';
    dragHandle.style.height = '30px';
    dragHandle.style.borderRadius = '5px';
    dragHandle.style.backgroundColor = 'rgba(67, 97, 238, 0.7)';
    dragHandle.style.color = 'white';
    dragHandle.style.fontSize = '18px';
    dragHandle.style.display = 'flex';
    dragHandle.style.justifyContent = 'center';
    dragHandle.style.alignItems = 'center';
    dragHandle.style.cursor = 'move';
    dragHandle.style.zIndex = '9200';
    dragHandle.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
    dragHandle.title = 'D√©placer la carte';

    // Styles pour les petits √©crans
    const dragHandleStyle = document.createElement('style');
    dragHandleStyle.textContent = `
    .heatmap-drag-handle {
        opacity: 0.4;
        transition: opacity 0.2s ease;
    }
    
    .heatmap-drag-handle:hover {
        opacity: 1;
    }
    `;

    document.head.appendChild(dragHandleStyle);
    heatmapWrapper.appendChild(dragHandle);

    // Cr√©er une poign√©e de redimensionnement sp√©cifique pour mobile
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'heatmap-resize-handle';
    resizeHandle.innerHTML = '‚§°';
    resizeHandle.style.fontFamily = 'Arial, sans-serif'; // Police simple et moderne
    resizeHandle.style.fontSize = '23px'; // Taille l√©g√®rement augment√©e
    resizeHandle.style.fontWeight = 'bold'; // Rendre la fl√®che plus visible
    resizeHandle.style.lineHeight = '1'; // Emp√™cher les probl√®mes de hauteur de ligne
    resizeHandle.style.paddingBottom = '4px';
    resizeHandle.style.position = 'absolute';
    resizeHandle.style.bottom = '0';
    resizeHandle.style.right = '0';
    resizeHandle.style.width = '25px';
    resizeHandle.style.height = '20px';
    resizeHandle.style.backgroundColor = 'rgba(67, 97, 238, 0.7)';
    resizeHandle.style.color = 'white';
    resizeHandle.style.display = 'flex';
    resizeHandle.style.justifyContent = 'center';
    resizeHandle.style.alignItems = 'center';
    resizeHandle.style.cursor = 'nwse-resize';
    resizeHandle.style.borderTopLeftRadius = '10px';
    resizeHandle.style.zIndex = '9200';
    resizeHandle.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
    resizeHandle.title = 'Redimensionner la carte';

    // Ajouter des styles pour l'affichage conditionnel
    const resizeHandleStyle = document.createElement('style');
    resizeHandleStyle.textContent = `
    .heatmap-resize-handle {
        opacity: 0.8;
        transition: opacity 0.2s ease;
        display: flex; /* Toujours affich√© */
    }
    
    .heatmap-resize-handle:hover {
        opacity: 1;
    }
    
    /* Sur les appareils tactiles, d√©sactiver le redimensionnement natif */
    @media (pointer: coarse) {
        #namecloud-heatmap-wrapper {
        resize: none !important;
        }
    }
    `;

    document.head.appendChild(resizeHandleStyle);
    heatmapWrapper.appendChild(resizeHandle);

    // Gestion du redimensionnement maintenant d√©plac√©e dans heatMapInteractions.js
    setupResizeHandlers(resizeHandle, heatmapWrapper);

    // Modification de l'appel √† makeElementDraggable pour inclure la nouvelle poign√©e
    makeElementDraggable(heatmapWrapper, [titleBar, dragHandle]);

    // Ajouter un √©couteur pour sauvegarder la position apr√®s d√©placement
    heatmapWrapper.addEventListener('mouseup', () => {
        saveHeatmapPosition();
    });

    // Ajouter un √©couteur pour le redimensionnement
    if (window.ResizeObserver) {
        const resizeObserver = new ResizeObserver(() => {
            saveHeatmapPosition();
        });
        
        resizeObserver.observe(heatmapWrapper);
        heatmapWrapper.resizeObserver = resizeObserver;
    }

    // S'assurer que le conteneur du nameCloud n'interf√®re pas
    const nameCloudContainer = document.getElementById('name-Cloud-Container');
    if (nameCloudContainer) {
        // Sauvegarder le z-index original pour le restaurer √† la fermeture
        nameCloudContainer.dataset.originalZIndex = nameCloudContainer.style.zIndex || 'auto';
        // Temporairement r√©duire son z-index pour que la heatmap soit au-dessus
        nameCloudContainer.style.zIndex = '1';
    }

    const restoreOriginalZindexes = () => {
        document.querySelectorAll('[data-original-z-index]').forEach(el => {
            el.style.zIndex = el.dataset.originalZIndex;
            // Nettoyer l'attribut data pour √©viter des probl√®mes futurs
            delete el.dataset.originalZIndex;
        });
    };

    // Initialiser la carte Leaflet
    setTimeout(() => {
        initializeLeafletMap(heatmapWrapper, mapContainer, locationData, restoreOriginalZindexes, heatmapTitle);
    }, 100); // Petit d√©lai pour s'assurer que le DOM est pr√™t

    return heatmapWrapper;
}

/**
 * Initialise la carte Leaflet et configure ses composants
 * 
 * @param {HTMLElement} heatmapWrapper - Conteneur principal de la heatmap
 * @param {HTMLElement} mapContainer - Conteneur sp√©cifique pour la carte Leaflet
 * @param {Array} locationData - Donn√©es √† afficher sur la carte
 * @param {Function} restoreOriginalZindexes - Fonction pour restaurer les z-index originaux
 */
function initializeLeafletMap(heatmapWrapper, mapContainer, locationData, restoreOriginalZindexes, heatmapTitle) {
    try {
        const map = L.map('ancestors-heatmap').setView([46.2276, 2.2137], 6); // Vue centr√©e sur la France

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // V√©rifier que nous avons des donn√©es valides
        if (!locationData || !Array.isArray(locationData) || locationData.length === 0) {
            console.error('Donn√©es de heatmap invalides:', locationData);
            return;
        }

        // Collecter les coordonn√©es valides
        const coordinates = locationData
            .filter(loc => loc.coords && typeof loc.coords.lat === 'number' && typeof loc.coords.lon === 'number')
            .map(loc => [loc.coords.lat, loc.coords.lon]);

        // V√©rifier qu'il y a des coordonn√©es valides
        if (coordinates.length === 0) {
            console.error('Aucune coordonn√©e valide trouv√©e dans les donn√©es');
            return;
        }

        // Cr√©er la couche de chaleur
        const heat = L.heatLayer(
            coordinates.map(coords => [...coords, 1]), 
            {
                radius: 25,
                blur: 15,
                maxZoom: 1,
            }
        ).addTo(map);

        // Ajouter des marqueurs interactifs
        locationData.forEach(location => {
            if (!location.coords || typeof location.coords.lat !== 'number' || typeof location.coords.lon !== 'number') {
                return;
            }

            const marker = L.circleMarker([location.coords.lat, location.coords.lon], {
                radius: 5,
                fillColor: 'white',
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Conteneur de d√©tails
            const detailsContainer = createDetailsContainer(heatmapWrapper);
            configureMarkerInteractions(marker, detailsContainer, location);
        });

        // Ajuster la vue √† toutes les coordonn√©es valides
        try {
            if (coordinates.length > 0) {
                const bounds = L.latLngBounds(coordinates);
                if (bounds.isValid()) {
                    map.fitBounds(bounds, {
                        padding: [50, 50]
                    });
                }
            }
        } catch (error) {
            console.error('Erreur lors de l\'ajustement de la vue:', error);
        }

        // G√©rer les √©v√©nements des boutons avec restauration des z-index
        document.getElementById('heatmap-close').addEventListener('click', () => {
            // Restaurer le z-index original du conteneur nameCloud
            const nameCloudContainer = document.getElementById('name-Cloud-Container');
            if (nameCloudContainer) {
                nameCloudContainer.style.zIndex = nameCloudContainer.dataset.originalZIndex;
                delete nameCloudContainer.dataset.originalZIndex;
            }
            
            // Restaurer les z-index originaux de tous les √©l√©ments
            restoreOriginalZindexes();
            
            // Supprimer la heatmap
            document.body.removeChild(heatmapWrapper);
        });

        // Cr√©er le titre int√©gr√© √† la carte (toujours visible)
        createMapTitle(mapContainer, heatmapTitle);
        
        // Cr√©er les contr√¥les de carte
        createMapControls(mapContainer, heatmapWrapper);
        
        // Configurer les boutons de zoom Leaflet
        configureLeafletZoomControls();
        
        // Masquer l'attribution Leaflet
        const attribution = document.querySelector('.leaflet-control-attribution');
        if (attribution) {
            attribution.style.display = 'none';
        }

        const currentCenter = map.getCenter();
        const currentZoom = map.getZoom();
        map.invalidateSize();
        map.setView(currentCenter, currentZoom, { animate: false });
        
        // Sauvegarde de la r√©f√©rence pour usage ult√©rieur
        heatmapWrapper.map = map;

        // Sauvegarder la position
        saveHeatmapPosition();
    } catch (error) {
        console.error('Erreur lors de l\'initialisation de la carte:', error);
        alert('Erreur lors de la cr√©ation de la carte. Voir console pour d√©tails.');
    }
}

/**
 * Cr√©e le conteneur pour afficher les d√©tails d'un point sur la carte
 * 
 * @param {HTMLElement} heatmapWrapper - Conteneur principal de la heatmap
 * @returns {HTMLElement} - Conteneur de d√©tails cr√©√©
 */
function createDetailsContainer(heatmapWrapper) {
    const detailsContainer = document.createElement('div');
    detailsContainer.id = 'heatmap-details';
    detailsContainer.style.padding = '10px';
    detailsContainer.style.backgroundColor = 'rgba(255,255,255,0.95)';
    detailsContainer.style.position = 'absolute';
    detailsContainer.style.bottom = '10px';
    detailsContainer.style.right = '10px';
    detailsContainer.style.zIndex = '9100'; // Z-index √©lev√© pour √™tre au-dessus de la carte
    detailsContainer.style.maxWidth = '300px';
    detailsContainer.style.maxHeight = '400px';
    detailsContainer.style.overflowY = 'auto';
    detailsContainer.style.borderRadius = '5px';
    detailsContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
    detailsContainer.style.display = 'none';
    heatmapWrapper.appendChild(detailsContainer);
    
    return detailsContainer;
}

/**
 * Configure les interactions d'un marqueur sur la carte
 * 
 * @param {L.CircleMarker} marker - Le marqueur Leaflet
 * @param {HTMLElement} detailsContainer - Conteneur pour afficher les d√©tails
 * @param {Object} location - Donn√©es de localisation associ√©es au marqueur
 */
function configureMarkerInteractions(marker, detailsContainer, location) {
    // Variable pour suivre l'√©tat d'ouverture
    let isDetailsOpen = false;
    
    // Fonction pour afficher les d√©tails
    const showDetails = () => {
        // Fermer tous les autres d√©tails ouverts
        document.querySelectorAll('.heatmap-details-open').forEach(el => {
            el.style.display = 'none';
            el.classList.remove('heatmap-details-open');
        });
        
        // Afficher et marquer ces d√©tails comme ouverts
        detailsContainer.style.display = 'block';
        detailsContainer.classList.add('heatmap-details-open');
        isDetailsOpen = true;
        
        // G√©n√©rer le contenu des d√©tails
        let details = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">D√©tails du point</h3>
                <button id="close-details" style="background: none; border: none; font-size: 16px; cursor: pointer;">‚úñ</button>
            </div>
            <p><strong>Lieu :</strong> ${location.placeName || "Lieu non sp√©cifi√©"}</p>
            <p><strong>Nombre total d'occurrences :</strong> ${location.count}</p>
        `;
    
        if (location.families && Object.keys(location.families).length > 0) {
            details += `<h4>Noms de famille (${Object.keys(location.families).length}):</h4>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px;">
                <ul style="margin: 0; padding-left: 20px;">`;
            
            // Trier les noms de famille par nombre d'occurrences
            const sortedFamilies = Object.entries(location.families)
                .sort((a, b) => b[1] - a[1]);
    
            // Afficher tous les noms de famille
            sortedFamilies.forEach(([family, count]) => {
                details += `<li>${family}: ${count} occurrence${count > 1 ? 's' : ''}</li>`;
            });
            
            details += `</ul></div>`;
        }
    
        if (location.locations && location.locations.length > 0) {
            details += `<h4>Personnes (${location.locations.length}):</h4>
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px;">
                <ul style="margin: 0; padding-left: 20px;">`;
            
            // Trier les personnes par type d'√©v√©nement et par ann√©e si disponible
            const sortedLocations = [...location.locations].sort((a, b) => {
                // D'abord par type d'√©v√©nement
                if (a.type !== b.type) {
                    return a.type.localeCompare(b.type);
                }
                // Ensuite par ann√©e si disponible
                if (a.year && b.year && a.year !== 'N/A' && b.year !== 'N/A') {
                    return parseInt(a.year) - parseInt(b.year);
                }
                // Sinon par nom
                return a.name.localeCompare(b.name);
            });
            
            // Afficher toutes les personnes
            sortedLocations.forEach(person => {
                details += `<li>${person.name} (${person.type}${person.year && person.year !== 'N/A' ? ` - ${person.year}` : ''})</li>`;
            });
            
            details += `</ul></div>`;
        }
    
        detailsContainer.innerHTML = details;
        
        // Ajouter un gestionnaire d'√©v√©nements pour le bouton de fermeture
        const closeButton = detailsContainer.querySelector('#close-details');
        if (closeButton) {
            closeButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Emp√™cher la propagation aux autres √©couteurs
                detailsContainer.style.display = 'none';
                detailsContainer.classList.remove('heatmap-details-open');
                isDetailsOpen = false;
            });
        }
    };

    // √âv√©nements de survol et de clic
    marker.on('mouseover', () => {
        if (!isDetailsOpen) {
            showDetails();
        }
    });
    
    marker.on('mouseout', (e) => {
        // Ne pas fermer si les d√©tails sont fix√©s (apr√®s un clic)
        if (!isDetailsOpen) {
            setTimeout(() => {
                // V√©rifier si la souris n'est pas revenue sur le conteneur de d√©tails
                const x = e.originalEvent.clientX;
                const y = e.originalEvent.clientY;
                const elem = document.elementFromPoint(x, y);
                if (!detailsContainer.contains(elem)) {
                    detailsContainer.style.display = 'none';
                }
            }, 100);
        }
    });
    
    marker.on('click', () => {
        // Basculer l'√©tat d'ouverture au clic
        isDetailsOpen = !isDetailsOpen;
        
        if (isDetailsOpen) {
            showDetails();
        } else {
            detailsContainer.style.display = 'none';
            detailsContainer.classList.remove('heatmap-details-open');
        }
    });

    // G√©rer les clics sur le conteneur de d√©tails lui-m√™me
    detailsContainer.addEventListener('click', (e) => {
        // Emp√™cher que les clics sur les d√©tails ne ferment l'info-bulle
        e.stopPropagation();
    });
    
    // Ajouter un √©couteur de document pour fermer les d√©tails quand on clique ailleurs
    document.addEventListener('click', (e) => {
        if (isDetailsOpen && !detailsContainer.contains(e.target) && 
            e.target !== marker._path) {
            detailsContainer.style.display = 'none';
            detailsContainer.classList.remove('heatmap-details-open');
            isDetailsOpen = false;
        }
    });
}

/**
 * Cr√©e le titre affich√© sur la carte
 * 
 * @param {HTMLElement} mapContainer - Conteneur de la carte
 * @param {String} heatmapTitle - Titre √† afficher
 */
function createMapTitle(mapContainer, heatmapTitle = 'Heatmap') {
    const mapTitle = document.createElement('div');
    mapTitle.id = 'heatmap-map-title';
    mapTitle.style.position = 'absolute';
    mapTitle.style.top = '10px';
    mapTitle.style.left = '10px';
    mapTitle.style.zIndex = '1000';
    mapTitle.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
    mapTitle.style.padding = '3px 6px';
    mapTitle.style.borderRadius = '4px';
    mapTitle.style.fontSize = '12px';
    mapTitle.style.fontWeight = 'bold';
    mapTitle.style.maxWidth = '70%';
    mapTitle.textContent = heatmapTitle.replace(/^Heatmap\s*-\s*/, '');
    mapContainer.appendChild(mapTitle);
}

/**
 * Cr√©e les contr√¥les de la carte (boutons de rafra√Æchissement et fermeture)
 * 
 * @param {HTMLElement} mapContainer - Conteneur de la carte
 * @param {HTMLElement} heatmapWrapper - Conteneur principal de la heatmap
 */
function createMapControls(mapContainer, heatmapWrapper) {
    const controlsContainer = document.createElement('div');
    controlsContainer.id = 'heatmap-map-controls';
    controlsContainer.style.position = 'absolute';
    controlsContainer.style.top = '10px';
    controlsContainer.style.right = '10px';
    controlsContainer.style.zIndex = '1000';
    controlsContainer.style.display = 'flex';
    controlsContainer.style.gap = '5px';
    
    // Bouton refresh
    const refreshBtn = document.createElement('button');
    refreshBtn.innerHTML = 'üîÑ';
    refreshBtn.title = 'Rafra√Æchir la heatmap';
    refreshBtn.style.width = '24px';
    refreshBtn.style.height = '24px';
    refreshBtn.style.padding = '0';
    refreshBtn.style.border = '1px solid #ccc';
    refreshBtn.style.borderRadius = '3px';
    refreshBtn.style.backgroundColor = 'white';
    refreshBtn.style.cursor = 'pointer';
    refreshBtn.style.fontSize = '12px';
    refreshBtn.style.display = 'flex';
    refreshBtn.style.justifyContent = 'center';
    refreshBtn.style.alignItems = 'center';
    
    // Bouton fermeture
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '‚úñ';
    closeBtn.title = 'Fermer la heatmap';
    closeBtn.style.width = '24px';
    closeBtn.style.height = '24px';
    closeBtn.style.padding = '0';
    closeBtn.style.border = '1px solid #ccc';
    closeBtn.style.borderRadius = '3px';
    closeBtn.style.backgroundColor = 'white';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '12px';
    closeBtn.style.display = 'flex';
    closeBtn.style.justifyContent = 'center';
    closeBtn.style.alignItems = 'center';
    
    // Ajouter les √©couteurs d'√©v√©nements
    refreshBtn.addEventListener('click', () => {
        if (typeof refreshHeatmap === 'function') {
            refreshHeatmap();
        }
    });
    
    closeBtn.addEventListener('click', () => {
        const wrapper = document.getElementById('namecloud-heatmap-wrapper');
        if (wrapper) {
            document.body.removeChild(wrapper);
            // Restaurer les z-index si n√©cessaire
            document.querySelectorAll('[data-original-z-index]').forEach(el => {
                el.style.zIndex = el.dataset.originalZIndex;
                delete el.dataset.originalZIndex;
            });
        }
    });
    
    controlsContainer.appendChild(refreshBtn);
    controlsContainer.appendChild(closeBtn);
    mapContainer.appendChild(controlsContainer);
}

/**
 * Configure les contr√¥les de zoom Leaflet
 */
function configureLeafletZoomControls() {
    const zoomControl = document.querySelector('.leaflet-control-zoom');
    if (zoomControl) {
        zoomControl.style.transform = 'scale(0.7)';
        zoomControl.style.transformOrigin = 'top right';
        zoomControl.style.marginTop = '40px';
        zoomControl.style.marginLeft = '-7px';
        
        const zoomButtons = zoomControl.querySelectorAll('a');
        zoomButtons.forEach(btn => {
            btn.style.width = '28px';
            btn.style.height = '28px';
            btn.style.lineHeight = '28px';
            btn.style.fontSize = '16px';
        });
    }
}

/**
 * Configure les gestionnaires d'√©v√©nements pour le redimensionnement
 * 
 * @param {HTMLElement} resizeHandle - Poign√©e de redimensionnement
 * @param {HTMLElement} heatmapWrapper - Conteneur principal de la heatmap
 */
function setupResizeHandlers(resizeHandle, heatmapWrapper) {
    // Variables pour le suivi du redimensionnement
    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    // Fonction pour g√©rer le d√©but du redimensionnement (souris)
    resizeHandle.addEventListener('mousedown', (e) => {
        initResize(e.clientX, e.clientY);
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', stopResize);
        e.preventDefault();
    });

    // Fonction pour g√©rer le d√©but du redimensionnement (tactile)
    resizeHandle.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            initResize(touch.clientX, touch.clientY);
            document.addEventListener('touchmove', resizeTouch);
            document.addEventListener('touchend', stopResize);
            document.addEventListener('touchcancel', stopResize);
            e.preventDefault();
        }
    });

    // Initialisation du redimensionnement
    function initResize(x, y) {
        isResizing = true;
        startX = x;
        startY = y;
        startWidth = heatmapWrapper.offsetWidth;
        startHeight = heatmapWrapper.offsetHeight;
        heatmapWrapper.style.userSelect = 'none'; // Emp√™cher la s√©lection de texte
        document.body.style.cursor = 'nwse-resize'; // Changer le curseur du document
    }

    // Fonction de redimensionnement (souris)
    function resize(e) {
        if (!isResizing) return;
        
        // Calculer la nouvelle taille
        const newWidth = startWidth + (e.clientX - startX);
        const newHeight = startHeight + (e.clientY - startY);
        
        // Appliquer la nouvelle taille avec des minimums
        heatmapWrapper.style.width = `${Math.max(50, newWidth)}px`;
        heatmapWrapper.style.height = `${Math.max(50, newHeight)}px`;
        
        // Rafra√Æchir la carte si elle existe
        if (heatmapWrapper.map) {
            heatmapWrapper.map.invalidateSize();
        }
    }

    // Fonction de redimensionnement (tactile)
    function resizeTouch(e) {
        if (!isResizing || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const newWidth = startWidth + (touch.clientX - startX);
        const newHeight = startHeight + (touch.clientY - startY);
        
        heatmapWrapper.style.width = `${Math.max(200, newWidth)}px`;
        heatmapWrapper.style.height = `${Math.max(150, newHeight)}px`;
        
        if (heatmapWrapper.map) {
            heatmapWrapper.map.invalidateSize();
        }
        
        // Emp√™cher le d√©filement de la page pendant le redimensionnement
        e.preventDefault();
    }

    // Arr√™t du redimensionnement
    function stopResize() {
        if (isResizing) {
            isResizing = false;
            heatmapWrapper.style.userSelect = '';
            document.body.style.cursor = '';
            
            // Supprimer les √©couteurs d'√©v√©nements
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('touchmove', resizeTouch);
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchend', stopResize);
            document.removeEventListener('touchcancel', stopResize);
            
            // Ajouter un petit d√©lai pour s'assurer que les animations sont termin√©es
            setTimeout(saveHeatmapPosition, 100);
        }
    }
}