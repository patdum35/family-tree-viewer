// 6 cas d'utilisation pour le service worker:
// 1- mode de test/developpement sur PC windows avec VS code et test avec Live Server
// 2- mode op√©rationnel sur PC avec le lien gitHub
// 3- mode op√©rationnel sur mobile avec le lien gitHub
// 4- mode op√©rationnel sur PC √† partir de l'appli install√©e
// 5- mode op√©rationnel sur mobile Android √† partir de l'appli install√©e
// 6- sur mobile IOS on ne peut pas installer l'appli

// Pour chacun des 6 cas il faut aussi consid√©rer le mode connect√© et le mode hors ligne

// Pour la mise √† jour √† jour du logiciel, avant de vider le cache, il faut √™tre s√ªr de 2 choses:
//  - mode connect√©
//  - serveur web disponible
//  - si ces 2 conditions ne sont pas r√©unies il faut interdire la mise √† jour du logiciel





// js/serviceWorkerInit.js - Code d√©plac√© depuis le HTML
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        // Ajouter un d√©lai pour s'assurer que la page est compl√®tement charg√©e
        setTimeout(() => {
            navigator.serviceWorker.register('./service-worker.js', {
                scope: './' // Sp√©cifier explicitement le scope
            }).then(function(registration) {
                console.log('ServiceWorker enregistr√© avec succ√®s sur scope: ', registration.scope);
                
                // V√©rifier si le service worker contr√¥le d√©j√† la page
                if (!navigator.serviceWorker.controller) {
                    console.log('ServiceWorker est enregistr√© mais ne contr√¥le pas encore la page');
                    
                    // Sur Chrome mobile, parfois il faut un rechargement
                    if (navigator.userAgent.includes('Android') || navigator.userAgent.includes('Mobile')) {
                        console.log('Appareil mobile d√©tect√©, tentative de prise de contr√¥le');
                        
                        // Activer le service worker s'il est en attente
                        if (registration.waiting) {
                            registration.waiting.postMessage({action: 'skipWaiting'});
                        }
                        
                        // Essayer de forcer la prise de contr√¥le
                        if (registration.active) {
                            registration.active.postMessage({action: 'claimClients'});
                        }
                        
                        // √âcouter les changements d'√©tat
                        navigator.serviceWorker.addEventListener('controllerchange', function() {
                            console.log('ServiceWorker a pris le contr√¥le, rechargement de la page');
                            // Recharger la page pour s'assurer que le SW la contr√¥le
                            window.location.reload();
                        });
                    }
                } else {
                    console.log('ServiceWorker contr√¥le d√©j√† cette page');
                }
                
                // Mettre √† jour le service worker si une nouvelle version est disponible
                registration.update().then(() => {
                    console.log('V√©rification des mises √† jour du SW effectu√©e');
                });
            }).catch(function(error) {
                console.error('√âchec d\'enregistrement du ServiceWorker:', error);
                
                // Tentative d'enregistrement avec une approche diff√©rente sur mobile
                if (navigator.userAgent.includes('Android') || navigator.userAgent.includes('Mobile')) {
                    console.log('Tentative alternative d\'enregistrement sur mobile');
                    
                    // Attendre un peu plus longtemps et r√©essayer
                    setTimeout(() => {
                        navigator.serviceWorker.register('./service-worker.js')
                        .then(reg => console.log('Enregistrement alternatif r√©ussi:', reg.scope))
                        .catch(err => console.error('√âchec d√©finitif:', err));
                    }, 3000);
                }
            });
        }, 1000); // D√©lai d'1 seconde avant d'essayer d'enregistrer le SW
    });
    
    // √âcouter les messages du service worker
    navigator.serviceWorker.addEventListener('message', function(event) {
        console.log('Message re√ßu du ServiceWorker:', event.data);
        
        // Traiter les messages sp√©cifiques
        if (event.data && event.data.action === 'reload') {
            console.log('Rechargement demand√© par le ServiceWorker');
            window.location.reload();
        }
    });
}




// Fonction pour d√©tecter l'environnement d'ex√©cution
function detectEnvironment() {
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const port = window.location.port;
    
    // Cas 1: D√©veloppement local avec Live Server
    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('192.168.')) {
        return {
            type: 'development',
            description: 'D√©veloppement local (VS Code Live Server)',
            requiresLocalServer: true
        };
    }
    
    // Cas 2: GitHub Pages ou autre h√©bergement web
    if (hostname.includes('github.io') || 
        hostname.includes('githubusercontent.com') ||
        (protocol === 'https:' && !hostname.includes('localhost'))) {
        return {
            type: 'production-web',
            description: 'Production web (GitHub Pages ou similaire)',
            requiresLocalServer: false
        };
    }
    
    // Cas 4 & 5: Application install√©e (PWA)
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
        return {
            type: 'pwa-installed',
            description: 'Application install√©e (PWA)',
            requiresLocalServer: false
        };
    }
    
    // Cas par d√©faut - probablement ouverture de fichier local
    return {
        type: 'file-local',
        description: 'Fichier local (file://)',
        requiresLocalServer: true
    };
}


// Fonction pour tester si un serveur web est disponible
async function isServerAvailable() {
    try {
        // Tentative de r√©cup√©ration d'un fichier avec un param√®tre al√©atoire pour √©viter le cache
        const testUrl = `./?test=${Date.now()}`;
        const response = await fetch(testUrl, {
            method: 'HEAD', // Utiliser HEAD pour minimiser le trafic
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache'
            },
            // Court timeout pour ne pas bloquer trop longtemps
            signal: AbortSignal.timeout(2000)
        });
        
        // Si la r√©ponse est OK, un serveur est disponible
        return response.ok;
    } catch (error) {
        console.log('Aucun serveur d√©tect√©:', error);
        return false;
    }
}


// Exposer une fonction pour forcer le nettoyage du cache
// window.clearAppCache = async function() {

//     console.log('üîç V√©rification de l\'environnement...');
    
//     // V√©rifier si un serveur est disponible (VS Code Live Server ou autre)
//     const hasServer = await isServerAvailable();
//     console.log('Serveur d√©tect√©:', hasServer ? 'OUI ‚úÖ' : 'NON ‚ùå');
    
//     // V√©rifier si on est sur mobile (Android fonctionne m√™me sans serveur)
//     const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Macintosh|Mac OS/i.test(navigator.userAgent);
//     console.log('Appareil mobile:', isMobile ? 'OUI ‚úÖ' : 'NON ‚ùå');
    

//     // const textMessage = `debug Appareil mobile: ${isMobile}`;
//     // console.log(textMessage);

//     // if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
//     //         navigator.serviceWorker.controller.postMessage({
//     //         action: textMessage
//     //     });
//     // }


//     // Si on est sur PC sans serveur, bloquer compl√®tement le vidage du cache
//     if (!hasServer && !isMobile) {
//     // if (true) {
//         console.warn('‚ö†Ô∏è Attention: Tentative de vidage du cache sans serveur disponible - BLOQU√âE');
        
//         // Utiliser la traduction appropri√©e via i18n
//         const message = window.i18n ? window.i18n.getText('noServerDetected') : 
//             '‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nAucun serveur n\'a √©t√© d√©tect√©. La mise √† jour du logiciel est impossible.\n\nCette op√©ration n√©cessite VS Code avec Live Server. ou vous ';
        
//         // const isMobile2 = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Macintosh|Mac OS/i.test(navigator.userAgent);

//         // const message = `‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nAucun serveur n\'a √©t√© d√©tect√©. La mise √† jour du logiciel est impossible.\n\nCette op√©ration n√©cessite VS Code avec Live Server. isMobile: ${isMobile2},   DEBUG********* ${ navigator.userAgent}`;
        

//         // Afficher l'alerte avec le message traduit
//         window.alert(message);
        
//         console.log('Op√©ration bloqu√©e: pas de serveur disponible sur PC');
        
//         // Fermer la modal si elle est ouverte
//         const modal = document.getElementById('gedcom-modal');
//         if (modal && modal.style.display === 'block') {
//             closeGedcomModal(); // Utiliser votre fonction existante pour fermer la modal
//         }
        
//         return false;
//     }


//     console.log('üîç V√©rification de la connexion avant vidage de cache...');
    
//     // Tester la vraie connectivit√©
//     const isConnected = await testRealConnectivity();
    
//     if (!isConnected) {
//         console.warn('‚ùå Pas de connexion Internet - vidage de cache bloqu√©');
//         alert('‚ö†Ô∏è Impossible de vider le cache en mode hors ligne.\n\nVeuillez vous reconnecter √† Internet avant de vider le cache.\n\n(Un t√©l√©chargement des nouvelles ressources est n√©cessaire)');
//         return false;
//     }
    
//     console.log('üåê Connexion Internet confirm√©e - proc√©dure de vidage autoris√©e');
    
//     if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
//         console.log('Envoi de la demande de vidage du cache au ServiceWorker');
        
//         // √âcouter la r√©ponse du Service Worker
//         navigator.serviceWorker.addEventListener('message', function onMessage(event) {
//             if (event.data && event.data.action === 'cacheCleared') {
//                 console.log('üî• Cache vid√©, rechargement...');
                
//                 // Supprimer l'√©couteur
//                 navigator.serviceWorker.removeEventListener('message', onMessage);
                
//                 // Recharger la page
//                 setTimeout(() => {
//                     window.location.reload();
//                 }, 1000);
//             }
//         });
        
//         navigator.serviceWorker.controller.postMessage({
//             action: 'clearCache'
//         });
//         return true;
//     } else {
//         console.warn('Pas de ServiceWorker actif pour vider le cache');
//         return false;
//     }
// };







// Fonction principale pour vider le cache
window.clearAppCache = async function() {
    console.log('üîç V√©rification de l\'environnement...');
    
    // D√©tecter l'environnement d'ex√©cution
    const environment = detectEnvironment();
    console.log(`Environnement d√©tect√©: ${environment.type} - ${environment.description}`);
    
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Macintosh|Mac OS/i.test(navigator.userAgent);
    console.log('Appareil mobile:', isMobile ? 'OUI ‚úÖ' : 'NON ‚ùå');
    
    // Logique diff√©rente selon l'environnement
    let canUpdate = false;
    let blockingReason = '';
    
    switch (environment.type) {
        case 'development':
            // Cas 1: D√©veloppement local - n√©cessite un serveur local
            const hasLocalServer = await isServerAvailable();
            console.log('Serveur local d√©tect√©:', hasLocalServer ? 'OUI ‚úÖ' : 'NON ‚ùå');
            
            if (!hasLocalServer) {
                blockingReason = 'D√©veloppement local sans serveur (VS Code Live Server requis)';
                canUpdate = false;
            } else {
                canUpdate = true;
            }
            break;
            
        case 'production-web':
            // Cas 2: GitHub Pages - n√©cessite une connexion Internet
            const hasInternet = await testRealConnectivity();
            console.log('Connexion Internet:', hasInternet ? 'OUI ‚úÖ' : 'NON ‚ùå');
            
            if (!hasInternet) {
                blockingReason = 'Pas de connexion Internet pour GitHub Pages';
                canUpdate = false;
            } else {
                canUpdate = true;
            }
            break;
            
        case 'pwa-installed':
            // Cas 4 & 5: PWA install√©e - v√©rifier la connectivit√©
            const hasConnection = await testRealConnectivity();
            console.log('Connexion pour PWA:', hasConnection ? 'OUI ‚úÖ' : 'NON ‚ùå');
            
            if (!hasConnection) {
                blockingReason = 'Pas de connexion Internet pour l\'application install√©e';
                canUpdate = false;
            } else {
                canUpdate = true;
            }
            break;
            
        case 'file-local':
            // Ouverture directe de fichier - toujours bloquer sauf sur mobile
            if (isMobile) {
                canUpdate = true; // Les mobiles peuvent fonctionner diff√©remment
            } else {
                blockingReason = 'Fichier ouvert localement sans serveur';
                canUpdate = false;
            }
            break;
    }
    
    // Si la mise √† jour est bloqu√©e, afficher un message appropri√©
    if (!canUpdate) {
        console.warn(`‚ö†Ô∏è Mise √† jour bloqu√©e: ${blockingReason}`);
        
        let message;
        if (environment.type === 'development') {
            message = window.i18n ? window.i18n.getText('noServerDetected') : 
                '‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nAucun serveur local n\'a √©t√© d√©tect√©.\n\nPour le d√©veloppement, veuillez utiliser VS Code avec Live Server.';
        } else if (environment.type === 'production-web') {
            message = window.i18n ? window.i18n.getText('noServerDetected2') : 
                '‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nPas de connexion Internet d√©tect√©e.\n\nLa mise √† jour n√©cessite une connexion pour t√©l√©charger les nouvelles ressources depuis GitHub.';
        } else {
            message = window.i18n ? window.i18n.getText('noServerDetected3') :
                '‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nLa mise √† jour du logiciel n\'est pas possible dans cet environnement.';
        }
        
        window.alert(message);
        
        // Fermer la modal si elle est ouverte
        const modal = document.getElementById('gedcom-modal');
        if (modal && modal.style.display === 'block') {
            closeGedcomModal();
        }
        
        return false;
    }
    
    console.log('‚úÖ Conditions remplies - proc√©dure de vidage autoris√©e');
    
    // Proc√©der au vidage du cache
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        console.log('Envoi de la demande de vidage du cache au ServiceWorker');
        
        // √âcouter la r√©ponse du Service Worker
        navigator.serviceWorker.addEventListener('message', function onMessage(event) {
            if (event.data && event.data.action === 'cacheCleared') {
                console.log('üî• Cache vid√©, rechargement...');
                
                // Supprimer l'√©couteur
                navigator.serviceWorker.removeEventListener('message', onMessage);
                
                // Recharger la page
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        });
        
        navigator.serviceWorker.controller.postMessage({
            action: 'clearCache'
        });
        return true;
    } else {
        console.warn('Pas de ServiceWorker actif pour vider le cache');
        return false;
    }
};